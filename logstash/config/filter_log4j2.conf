# Filtre pour les applications Tomcat, avec des particulalités pour les applications IO
filter {
  if [type] == "log4j"{
    multiline {
      pattern => "^\\s"
      what => "previous"
    }

    # IP de la source dans host_ip
    mutate {
      add_field => [ "host_ip", "%{host}" ]
    }
    mutate {
      gsub => ["host_ip", ":.*$", ""]
    }

    # Si c'est un log performance
    if [path] == "performance" {
      mutate {
        add_field => {
          "Status" => "NONE"
        }
      }
        
      # Si c'est un Before Running ou un Post Parameter
      if [message]=~ /(Before\sRunning\smethod\sGET)/ or [message]=~ /(POST\sParameters\s)/  {
        mutate {
          update => { "Status" => "PARAMETERS"}
        }
        grok {
          match => ["message", "%{GREEDYDATA:contenuMessage}%{URIPATH:uripath}%{URIPARAM:uriparam}"]
        }
        # Split des paramètres de la requête
        kv {
          field_split => "&?"
          source => "uriparam"
          include_keys => [ "page", "ver" , "cat" , "codeope", "typRch", "don", "cmd", "dupliquer", "flux", "radMod", "radTyp" ]
        }
        mutate {
          add_field => {
            "Application" => "EMPTY"
            "MODULE" => "EMPTY"
            "FCT" => "EMPTY"
            "SOUS-FCT" => "EMPTY"
          }
        }

        # Authentification
        if [uripath] == "/Authentification" and ![page] {
                mutate {
                        update =>  {
                                "MODULE" => "LOGIN"
                                "FCT" => "LOGIN"
                                "SOUS-FCT" => "Page de login"
                        }
                }

        } else if [uripath] == "/Accueil" and ![page] {
                mutate {
                        update =>  {
                                "MODULE" => "Connexion"
                                "FCT" => "ACCUEIL"
                                "SOUS-FCT" => "Page d'accueil"
                        }
                }
        } else if [uripath] == "/Reparation"  {

                if ![page] and [ver] =~ /(?:[+-]?(?:[0-9]+))/ {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "REPARATION"
                                        "SOUS-FCT" => "Devis de réparation"
                                }
                        }
                } else if [page] == "donnee" and [cat] =~ /(?:[+-]?(?:[0-9]+))/ and [codeope] =~ /(?:[+-]?(?:[0-9]+))/ {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "REPARATION"
                                        "SOUS-FCT" => "Affichage d'une sous famille"
                                }
                        }
                } else if [page] == "aproposVehicule" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "REPARATION"
                                        "SOUS-FCT" => "Affichage de la page de détail du véhicule concerné"
                                }
                        }
                }
        } else if [uripath] == "/DonneeTechnique" {
                mutate {
                        update =>  {
                                "MODULE" => "ATELIER"
                                "FCT" => "METHODES ET DONNES"
                                "SOUS-FCT" => "Méthode det données"
                        }
                }
        } else if [uripath] == "/Caroos" {
                mutate {
                        update =>  {
                                "MODULE" => "ATELIER"
                                "FCT" => "CARROSSERIE"
                                "SOUS-FCT" => "Carrosserie rapide"
                        }
                }
        } else if [uripath] == "/GestionAffichageOngletATD" {
                mutate {
                        update =>  {
                                "MODULE" => "ATELIER"
                                "FCT" => "ATELIO_DOC"
                                "SOUS-FCT" => "Atelio Doc"
                        }
                }
        }  else if [uripath] == "/RecherchePneu" and [page] == "rechercheAccueil" {
                #Recherche Pneu
                mutate {
                        update =>  {
                                "MODULE" => "ATELIER"
                                "FCT" => "PNEU"
                                "SOUS-FCT" => "Pneus (mode affecté, non affecté)"
                        }
                }
        }  else if [uripath] == "/SelectionGraphique"{
                #Recherche Pneu
                mutate {
                        update =>  {
                                "MODULE" => "ATELIER"
                                "FCT" => "GESTION_GRAPHIQUE"
                                "SOUS-FCT" => "Affichage planche graphique"
                        }
                }
        } else if [uripath] == "/RecherchePiece"  {
                #Recherche Piece
                if [page] == "rechercheParReferenceNonAffecte"  {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Accueil Recherche par référence Non-Affecté"
                                }
                        }
                } else if [page] == "rechercheParReference"  {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Accueil Recherche par référence Affecté"
                                }
                        }
                } else if [typRch] == "ReferenceCommencePar"  {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Commence-Par Non Affecté"
                                }
                        }
                } else if [typRch] == "ReferenceCommenceParAtelier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Commence-Par Affecté"
                                }
                        }
                } else if [typRch] == "ReferenceExacte"  {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Exacte Non-affecté"
                                }
                        }
                } else if [typRch] == "ReferenceContient" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Contient Non-affecté"
                                }
                        }
                } else if [typRch] == "ReferenceDirecte" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "?????"

                                }
                        }
                } else if [typRch] == "ReferenceFiniPar" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Fini-Par Affecté"

                                }
                        }
                }   else if [typRch] == "ReferenceContientAtelier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Contient Affecté"

                                }
                        }
                }       else if [typRch] == "ReferenceFiniParAtelier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Fini Affecté"

                                }
                        }
                }       else if [typRch] == "recherchePieceParRefExacteParLAtelier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "RECHERCHE_REF"
                                        "SOUS-FCT" => "Recherche Exact Affecté"
                                }
                        }
                }
        } else if [uripath] == "/RevisionEtape1" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "PLAN_ENTRETIEN"
                                        "SOUS-FCT" => "Etape 1"
                                }
                        }
        } else if [uripath] == "/RevisionEtape2" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "PLAN_ENTRETIEN"
                                        "SOUS-FCT" => "Etape 2"
                                }
                        }
        } else if [uripath] == "/RevisionEtape3" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "PLAN_ENTRETIEN"
                                        "SOUS-FCT" => "Etape 3"

                                }
                        }
        } else if [uripath] == "/RevisionEtape4" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "PLAN_ENTRETIEN"
                                        "SOUS-FCT" => "Etape 4"

                                }
                        }
        } else if [uripath] == "/Accueil"   {
                 if [page] == "configuration" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "CONFIGURATION"
                                        "SOUS-FCT" => "Configuration du garage"

                                }
                        }
                } else  if [page] == "logout" {
                        mutate {
                                update =>  {
                                        "MODULE" => "Connexion"
                                        "FCT" => "DECONNEXION"
                                        "SOUS-FCT" => "Deconnexion de la page"

                                }
                        }
                }
        } else if [uripath] == "/ConfigurationAffichageUtilisateurs" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "CONFIGURATION"
                                        "SOUS-FCT" => "Configuration de l'affichage"

                                }
                        }
        }  else if [uripath] == "/DonneePerso" {
                if [don] == "pce" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AFFICHAGE ELEMENTS GARAGE"
                                        "SOUS-FCT" => "Affichage des pièces du garage"

                                }
                        }
                 }      else if [don] == "for" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AFFICHAGE ELEMENTS GARAGE"
                                        "SOUS-FCT" => "Affichage des forfaits du garage"

                                }
                        }
                 } else if [don] == "ing" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AFFICHAGE ELEMENTS GARAGE"
                                        "SOUS-FCT" => "Affichage  des ingrédients du garage"

                                }
                        }
                 }      else if [don] == "tps" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AFFICHAGE ELEMENTS GARAGE"
                                        "SOUS-FCT" => "Affichage des temps du garage"

                                }
                        }
                 }
        } else if [uripath] == "/DetailDP" {
                if [don] == "pce" and [cmd] == "add" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AJOUT ELEMENT GARAGE"
                                        "SOUS-FCT" => "Création d'une nouvelle pièce"

                                }
                        }
                 }      else if [don] == "for" and [cmd] == "add" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AJOUT ELEMENT GARAGE"
                                        "SOUS-FCT" => "Création d'u nouveau forfait"

                                }
                        }
                 } else if [don] == "ing" and [cmd] == "add" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AJOUT ELEMENT GARAGE"
                                        "SOUS-FCT" => "Création d'un nouvel ingrédient"

                                }
                        }
                 }      else if [don] == "tps" and [cmd] == "add" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "AJOUT ELEMENT GARAGE"
                                        "SOUS-FCT" => "Création d'u nouveau temps"

                                }
                        }
                 }
        } else if [uripath] == "/RechercheClient" {
                        mutate {
                                update =>  {
                                        "MODULE" => "GARAGE"
                                        "FCT" => "CLIENT"
                                        "SOUS-FCT" => "Gestion des clients"

                                }
                        }
        }  else if [uripath] == "/Devis" {
                if [page] == "afficheDevis" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "DEVIS"
                                        "SOUS-FCT" => "Afficher un devis"
                                }
                        }
                 }      else if [page] == "verifierAjoutDoublonDansDevis" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "DEVIS"
                                        "SOUS-FCT" => "Verifier Ajout doublon"
                                }
                        }
                 } else if [page] == "ajoutDevis" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "DEVIS"
                                        "SOUS-FCT" => "Ajouter element dans  devis"
                                }
                        }
                 }      else if [page] == "nouveauDevis" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "DEVIS"
                                        "SOUS-FCT" => "Nouveau devis"
                                }
                        }
                 }      else if [page] == "infoDevis" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "DEVIS"
                                        "SOUS-FCT" => "Information sur devis"
                                }
                        }
                 }      else if [page] == "nouveauPanier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "PANIER"
                                        "SOUS-FCT" => "Nouveau Panier"
                                }
                        }
                 }      else if [page] == "ajoutPanier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "PANIER"
                                        "SOUS-FCT" => "Ajout d'une pièce au panier"
                                }
                        }
                 } else if [page] == "infoPanier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "PANIER"
                                        "SOUS-FCT" => "Information panier"
                                }
                        }
                 } else if [page] == "panier" and [dupliquer] == "true" {
                        mutate {
                                update =>  {
                                        "MODULE" => "TRANSVERSE"
                                        "FCT" => "PANIER"
                                        "SOUS-FCT" => "Dupliquer le panier"
                                }
                        }
                 }
        } else if [uripath] == "/startDirectIdent.do" {
                mutate {
                        update =>  {
                                "MODULE" => "IDENT"
                                "FCT" => "Vehicule"
                                "SOUS-FCT" => "Identification véhicule à partir du Widget"
                        }
                }
        }  else if [uripath] == "/postSearchIdent.do" {
                mutate {
                        update =>  {
                                "MODULE" => "IDENT"
                                "FCT" => "Vehicule"
                                "SOUS-FCT" => "Identification véhicule à partir du module recherche assistée"
                        }
                }
        } else if [uripath] == "/Mra" {
                mutate {
                        update =>  {
                                "MODULE" => "IDENT"
                                "FCT" => "Vehicule"
                                "SOUS-FCT" => "Redirection de l'utilisateur"
                        }
                }
        } else if [uripath] == "/AjaxPrixEtStock" {
                if [page] == "update" {
                        mutate {
                                update =>  {
                                        "MODULE" => "XAT2V1_XAT2V2"
                                        "FCT" => "RECUPERATION P&S"
                                        "SOUS-FCT" => "Mise à jour les prix et stocks"
                                }
                        }
                 }      else if [page] == "check" {
                        mutate {
                                update =>  {
                                        "MODULE" => "XAT2V1_XAT2V2"
                                        "FCT" => "RECUPERATION P&S"
                                        "SOUS-FCT" => "Gestion de redirection vers le DMS ou attente des P&S"
                                }
                        }
                 }      else if ![page]  {
                        mutate {
                                update =>  {
                                        "MODULE" => "XAT2V1_XAT2V2"
                                        "FCT" => "RECUPERATION P&S"
                                        "SOUS-FCT" => "Envoie de la requete P&S"
                                }
                        }
                 }
        }  else if [uripath] == "/CommunicationToutesInterface" {
                if [flux] == "devis" {
                        mutate {
                                update =>  {
                                        "MODULE" => "XAT2V1/XAT2V2"
                                        "FCT" => "TRANSFERT"
                                        "SOUS-FCT" => "Transfert devis"
                                }
                        }
                 }      else if [flux] == "panier" {
                        mutate {
                                update =>  {
                                        "MODULE" => "XAT2V1/XAT2V2"
                                        "FCT" => "TRANSFERT"
                                        "SOUS-FCT" => "Transfert Panier"
                                }
                        }
                 }
        }  else if [uripath] == "/Impression" and [cmd] == "imp" {
                if [radTyp] == "0" and [radMod] == "1" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Estimatif en mode forfait"
                                }
                        }
                 }      else if [radTyp] == "0" and [radMod] == "0" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Estimatif en mode normal"
                                }
                        }
                 } else if [radTyp] == "1" and [radMod] == "1" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Devis en mode forfait"
                                }
                        }
                 } else if [radTyp] == "1" and [radMod] == "0" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Devis en mode normal"
                                }
                        }
                 }      else if [radTyp] == "2" and [radMod] == "0" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Facture en mode normal"
                                }
                        }
                 }      else if [radTyp] == "2" and [radMod] == "1" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Facture en mode forfait"
                                }
                        }
                 }      else if [radTyp] == "3" and [radMod] == "0" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Avoir en mode normal"
                                }
                        }
                 }      else if [radTyp] == "3" and [radMod] == "1" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Avoir en mode forfait"
                                }
                        }
                 }      else if [radTyp] == "5" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Ordre de réparation"
                                }
                        }
                 }      else if [radTyp] == "7" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Plan générique"
                                }
                        }
                 }      else if [radTyp] == "8" {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Impression Panier"
                                }
                        }
                 }      else if ![cmd] {
                        mutate {
                                update =>  {
                                        "MODULE" => "ATELIER"
                                        "FCT" => "IMPRESSION"
                                        "SOUS-FCT" => "Preparation Impression"
                                }
                        }
                }
        }
                        
      } else if [message] =~ /(-\sRunning method\s)/ {
        mutate {
          update => {
            "Status" => "RUNNING"
          }
        }
        grok {
          match => ["message", "%{BASE10NUM:RUNNING_TIME} milliseconds - Running method %{WORD} /%{WORD:uripath}"]
        }
      } else if [message] =~ /(\sBefore Running method POST\s)/ {
        # Suppression des message Before Running methode POST
        drop { }
      }
    }

    if "io-front" in [tags] {
      mutate {
        update => [ "Application", "FRONT" ]
      }
    } else if "io-admin" in [tags] {
      mutate {
        update => [ "Application", "ADMIN" ]
      }
    }

    mutate {
      convert => [ "RUNNING_TIME", "integer" ]
    }
  }     
}
